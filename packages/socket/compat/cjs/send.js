"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var _newArrowCheck=_interopDefault(require("babel-runtime/helpers/newArrowCheck"));require("phoenix");var utilsComposite=require("@jumpn/utils-composite"),utilsArray=require("@jumpn/utils-array"),_JSON$stringify=_interopDefault(require("babel-runtime/core-js/json/stringify")),_extends=_interopDefault(require("babel-runtime/helpers/extends")),utilsGraphql=require("@jumpn/utils-graphql"),_this=void 0,handlePush=function(e,i){return _newArrowCheck(this,_this),e.receive("ok",i.onSucceed).receive("error",i.onError).receive("timeout",i.onTimeout)}.bind(void 0),_this$1=void 0,getNotifier=function(e,i){return _newArrowCheck(this,_this$1),function(n){return _newArrowCheck(this,_this$1),n[e]&&n[e](i)}.bind(this)}.bind(void 0),getHandlerName=function(e){return _newArrowCheck(this,_this$1),"on"+String(e)}.bind(void 0),notify=function(e,i,n){return _newArrowCheck(this,_this$1),e.observers.forEach(getNotifier(getHandlerName(i),n))}.bind(void 0),_this$2=void 0,notifyall=function(e,i,n){return _newArrowCheck(this,_this$2),e.forEach(function(e){return _newArrowCheck(this,_this$2),notify(e,i,n)}.bind(this))}.bind(void 0),_this$3=void 0,find=function(e,i,n){return _newArrowCheck(this,_this$3),e.find(utilsComposite.hasIn([i],n))}.bind(void 0),_this$4=void 0,createEventHandler=function(e,i){return _newArrowCheck(this,_this$4),function(n){return _newArrowCheck(this,_this$4),function(){for(var r=arguments.length,t=Array(r),o=0;o<r;o++)t[o]=arguments[o];_newArrowCheck(this,_this$4);var s=find(e.notifiers,"request",i);s&&n.apply(void 0,[e,s].concat(t))}.bind(this)}.bind(this)}.bind(void 0),createPushHandler=function(e,i,n){return _newArrowCheck(this,_this$4),utilsComposite.map(createEventHandler(i,n),e)}.bind(void 0),_this$5=void 0,findIndex=function(e,i,n){return _newArrowCheck(this,_this$5),e.findIndex(utilsComposite.hasIn([i],n))}.bind(void 0),_this$6=void 0,remove=function(e){return _newArrowCheck(this,_this$6),function(i){return _newArrowCheck(this,_this$6),utilsArray.remove(findIndex(i,"request",e.request),1,i)}.bind(this)}.bind(void 0),_this$7=void 0,refresh=function(e){return _newArrowCheck(this,_this$7),function(i){return _newArrowCheck(this,_this$7),utilsArray.replace(findIndex(i,"request",e.request),[e],i)}.bind(this)}.bind(void 0),_this$8=void 0,updateNotifiers=function(e,i){return _newArrowCheck(this,_this$8),e.notifiers=i(e.notifiers),e}.bind(void 0),_this$9=void 0,notifyStart=function(e){return _newArrowCheck(this,_this$9),notify(e,"Start",e)}.bind(void 0),onSubscriptionSucceed=function(e,i,n){var r=n.subscriptionId;_newArrowCheck(this,_this$9);var t=_extends({},i,{subscriptionId:r});updateNotifiers(e,refresh(t)),notifyStart(t)}.bind(void 0),abortRequest=function(e,i,n){_newArrowCheck(this,_this$9),updateNotifiers(e,remove(i)),notify(i,"Abort",n)}.bind(void 0),onError=function(e,i,n){return _newArrowCheck(this,_this$9),abortRequest(e,i,new Error(_JSON$stringify(n)))}.bind(void 0),onSubscriptionResponse=function(e,i,n){_newArrowCheck(this,_this$9),n.errors?onError(e,i,utilsGraphql.errorsToString(n.errors)):onSubscriptionSucceed(e,i,n)}.bind(void 0),onQueryOrMutationResponse=function(e,i,n){_newArrowCheck(this,_this$9),updateNotifiers(e,remove(i)),notify(i,"Result",n)}.bind(void 0),onTimeout=function(e,i){return _newArrowCheck(this,_this$9),notify(i,"Error",new Error("request: timeout"))}.bind(void 0),queryOrMutationHandler={onError:onError,onTimeout:onTimeout,onSucceed:onQueryOrMutationResponse},subcriptionHandler={onError:onError,onTimeout:onTimeout,onSucceed:onSubscriptionResponse},send=function(e,i,n){return _newArrowCheck(this,_this$9),handlePush(e.channel.push("doc",utilsGraphql.requestToCompat(i)),createPushHandler(n,e,i))}.bind(void 0),pushRequest=function(e,i){_newArrowCheck(this,_this$9),"subscription"===i.operationType?send(e,i.request,subcriptionHandler):(notifyStart(i),send(e,i.request,queryOrMutationHandler))}.bind(void 0),_this$10=void 0,createChannelJoinHandler=function(e){return _newArrowCheck(this,_this$10),{onError:function(i){return _newArrowCheck(this,_this$10),notifyall(e.notifiers,"Error",new Error("channel join: "+String(i)))}.bind(this),onSucceed:function(){return _newArrowCheck(this,_this$10),e.notifiers.forEach(function(i){return _newArrowCheck(this,_this$10),pushRequest(e,i)}.bind(this))}.bind(this),onTimeout:function(){return _newArrowCheck(this,_this$10),notifyall(e.notifiers,"Error",new Error("channel join: timeout"))}.bind(this)}}.bind(void 0),joinChannel=function(e){return _newArrowCheck(this,_this$10),handlePush(e.channel.join(),createChannelJoinHandler(e)),e.channelJoinCreated=!0,e}.bind(void 0),_this$11=void 0,create=function(e){return _newArrowCheck(this,_this$11),{request:e,observers:[],operationType:utilsGraphql.getOperationType(e.operation),subscriptionId:void 0}}.bind(void 0),_this$12=void 0,connectOrJoinChannel=function(e){_newArrowCheck(this,_this$12),e.phoenixSocket.isConnected()?joinChannel(e):e.phoenixSocket.connect()}.bind(void 0),sendNew=function(e,i){_newArrowCheck(this,_this$12);var n=create(i);return updateNotifiers(e,utilsArray.append([n])),e.channelJoinCreated?pushRequest(e,n):connectOrJoinChannel(e),n}.bind(void 0),send$1=function(e,i){return _newArrowCheck(this,_this$12),find(e.notifiers,"request",i)||sendNew(e,i)}.bind(void 0);module.exports=send$1;
//# sourceMappingURL=send.js.map
